# 綠界科技 ECPay 付款結果通知 (ReturnURL) 技術文件說明

## 中文核心邏輯解讀

這份文件說明了當消費者在綠界完成付款（或未完成）後，綠界伺服器如何通知我們的後端伺服器。這與使用者瀏覽器被導回哪裡 (`OrderResultURL`) 是兩件獨立的事。

核心重點如下：

1.  **通知方式**:
    *   綠界伺服器會直接對我們設定的 `ReturnURL` 發送一個 `POST` 請求。
    *   這個過程完全在後端發生，使用者無感。

2.  **驗證真實性 (最重要的安全機制)**:
    *   在收到的所有資料中，有一個 `CheckMacValue` 欄位。
    *   我們**必須**使用收到的其他資料，加上我們自己的 `HashKey` 和 `HashIV`，透過綠界提供的公式重新計算一次 `CheckMacValue`。
    *   只有在我們算出的值與綠界給的值完全相符時，才能相信這筆通知是真實、未被竄改的。**如果沒有做這個驗證，系統將有嚴重的安全漏洞。**

3.  **判斷付款狀態**:
    *   在驗證 `CheckMacValue` 通過後，我們需要檢查 `RtnCode` 這個欄位。
    *   只有當 `RtnCode` 的值為 `1` 時，才代表「付款成功」。
    *   任何其他的值都代表交易失敗、異常或處理中。

4.  **回應方式**:
    *   不論我們後續處理成功或失敗，只要收到了通知，就必須回應 `1|OK` 給綠界。
    *   這只是告知綠界「我們收到了」，避免它重複發送通知，不代表我們承認這筆交易成功。

5.  **模擬付款**:
    *   文件提到一個 `SimulatePaid` 欄位，值為 `1` 時代表這是從綠界後台發起的模擬測試，並非真實付款。在處理時需要注意，不能當作真實訂單出貨。

**總結：** 一個安全可靠的 `ReturnURL` 處理流程必須包含**驗證 `CheckMacValue`** 和**檢查 `RtnCode`** 這兩個關鍵步驟。

---

## 綠界官方文件原文

### 應用場景
Server端方式(POST)(ReturnURL)
當消費者付款完成後，特店接受綠界的付款結果訊息，並回應接收訊息

Step1.綠界：以ServerPost方式傳送付款結果訊息至特店的Server網址(ReturnURL)
Step2.特店：收到儲存綠界的付款結果訊息，回應1|OK
Step3.特店：使用排程判斷綠界的付款結果檢查碼是否相符並更新訂單狀態
❗ 注意事項：

*   超商繳費條碼(BARCODE)因超商端作業時間關係會於消費者付款完成兩天後回傳。
*   ATM、CVS、BARCODE可透過廠商管理後台的『模擬付款』，來確認ReturnURL是否正確接收付款結果通知。
*   1|OK僅是廠商回應綠界是否收到通知，並不會改變付款狀態。
*   若因授權時間過久未收到付款結果通知訊息時，請使用查詢訂單API查詢後再顯示付款結果。
*   ReturnURL和 OrderResultURL沒有固定的先後順序，會依當下連線速度與系統執行速度而定

### Client端方式(POST)(OrderResultURL)
當消費者付款完成後，綠界一次性反饋付款結果通知，並將頁面導至特店自製頁面

Step1.綠界：傳送付款結果並將頁面導至特店的自製頁面網址(OrderResultURL)
Step2.特店：收到綠界的付款結果訊息，並判斷檢查碼是否相符
❗ 注意事項：

*   若要將付款結果頁顯示於特店自製頁面，請設定[OrderResultURL]。反之，未設定則會停留於綠界付款成功頁面。
*   若[OrderResultURL]與[ClientBackURL]同時設定，將會以[OrderResultURL]為主。
*   部分銀行WebATM在交易成功後，會停留在銀行的頁面，並不會導回給綠界，因此綠界也不會將頁面導回到[OrderResultURL]的頁面
*   銀聯卡及非即時交易(ATM、CVS、BARCODE)不支援此參數。
*   建議在測試階段時先不要設定此參數，可將畫面停留在綠界，看見綠界所提供的錯誤訊息，便可有效除錯。
*   若有設定此參數，請務必根據回傳的交易狀態來判斷顯示付款成功與否的頁面。
*   因各家銀行授權時間不同，若因授權時間過久未收到反饋訊息，請使用查詢訂單API查詢後再顯示付款結果。
*   若此參數設定網址未使用https時，部份瀏覽器可能會出現警告訊息提醒。

### 綠界回傳參數說明
*   **MerchantID** String(10): 特店編號
*   **MerchantTradeNo** String(20): 特店交易編號
*   **StoreID** String(20): 特店旗下店舖代號
*   **RtnCode** Int: 交易狀態 (若回傳值為1時，為付款成功)
*   **RtnMsg** String(200): 交易訊息
*   **TradeNo** String(20): 綠界的交易編號
*   **TradeAmt** Int: 交易金額
*   **PaymentDate** String(20): 付款時間 (格式為yyyy/MM/dd HH:mm:ss)
*   **PaymentType** String(20): 付款方式
*   **PaymentTypeChargeFee** Number: 交易服務金額
*   **TradeDate** String(20): 訂單成立時間 (格式為yyyy/MM/dd HH:mm:ss)
*   **PlatformID** String(10): 特約合作平台商代號
*   **SimulatePaid** Int: 是否為模擬付款 (0:非模擬, 1:模擬)
*   **CustomField1-4** String(50): 自訂名稱欄位
*   **CheckMacValue** String: 檢查碼
